---
title: "analysis_vii_skills_flows_ii"
author: "Hunter York"
date: "12/6/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

library(ggplot2)
library(dplyr)
library(magrittr)
library(stringr)
library(readxl)
library(ggrepel)
library(foreign)
library(ipumsr)
library(data.table)
library(factoextra)



options
theme_set(theme_bw(base_size = 7)) 

# load the data
setwd("/Users/hyork/Documents/projects/occupation/code")

weighted.var <- function(x, w, na.rm = FALSE) {
  if (na.rm) {
    w <- w[i <- !is.na(x)]
    x <- x[i]
  }
  sum.w <- sum(w)
  sum.w2 <- sum(w^2)
  mean.w <- sum(x * w) / sum(w)
  (sum.w / (sum.w^2 - sum.w2)) * sum(w * (x - mean.w)^2, na.rm =
                                       na.rm)
}



# acs <- readstata13::read.dta13("../inputs/cps_00011.dta")
# acs2 <- fread("../inputs/cps_00008.csv")
# acs <- cbind(acs, acs2[,.(OCC2010, OCC1990,OCC1950, OCC, OCCLY,OCC50LY, OCC90LY, OCC10LY, HOURWAGE)])
# acs <- acs[acs$empstat == "at work" &
#                              (acs$schlcoll %like% "does not attend|niu"| is.na(acs$schlcoll)) &
#                              as.numeric(as.character(acs$age)) %in% 25:64 &
#                             acs$wkswork1 >= 30 &
#                              acs$incwage != 99999999 &
#                              acs$incwage > 0,]
# acs <- data.table(acs)
#keep vars
# acs <- acs[,.(race,relate,serial, hispan, year,asecwt, sex, age, schlcoll,educ, empstat,OCC,OCC2010,OCC1990, ind,ind1990, classwkr, ahrsworkt,wkswork1, uhrsworkly,classwly,workly,OCCLY,indly,OCC90LY,OCC1950, OCC50LY,ind90ly,OCC10LY, incwage, HOURWAGE,whymove, strechlk, whyptly)]

# subset


#saveRDS(acs, "../inputs/cps_00010.rds")
acs <- readRDS( "../inputs/cps_00010.rds")

# derive a 5-year age var
acs[, age_cat := paste0(floor(as.numeric(as.character(age))/5)*5,
                        " to ", 
                        floor(as.numeric(as.character(age))/5)*5 + 4)]

acs[, log_incwage := log(incwage + 1)]

#
#acs <- acs[year %in% seq(1990,1999,3)]

# load occ_soc xwalk
occ_xwalk <- data.table(read_excel("../ref/nem-occcode-cps-crosswalk.xlsx"))
names(occ_xwalk) <- occ_xwalk[4,] %>% unlist()
occ_xwalk <- occ_xwalk[-(1:4),]
occ_xwalk[, OCCSOC := gsub("-", "", `Hybrid SOC Code`)]

# now create skills dataset
skills_2009 <- read.delim('../ref/db_14_0 2009.7/Skills.txt') %>% data.table()
skills_2013 <-  read.delim('../ref/db_18_0_2013.7/Skills.txt') %>% data.table()
skills_2018 <- read_excel("../ref/db_22_2_excel 2018.2/Skills.xlsx") %>% data.table()
skills_2009[, year := 2009]
skills_2013[, year := 2013]
skills_2018[, year := 2018]
setnames(skills_2018, names(skills_2018), gsub(" ", ".", names(skills_2018), fixed = T))
skills_2018[, `O.NET.SOC.Code` := `O*NET-SOC.Code`]
skills <- rbindlist(list(skills_2009, skills_2013, skills_2018), fill = T)
skills <- skills[, .(O.NET.SOC.Code, Element.Name, Scale.ID, Data.Value, Standard.Error, year)]
skills[, Element.Name := paste0("skl_", Element.Name)]
# add abilities
abilities_2009 <- read.delim('../ref/db_14_0 2009.7/Abilities.txt') %>% data.table()
abilities_2013 <-  read.delim('../ref/db_18_0_2013.7/Abilities.txt') %>% data.table()
abilities_2018 <- read_excel("../ref/db_22_2_excel 2018.2/Abilities.xlsx") %>% data.table()
abilities_2009[, year := 2009]
abilities_2013[, year := 2013]
abilities_2018[, year := 2018]
setnames(abilities_2018, names(abilities_2018), gsub(" ", ".", names(abilities_2018), fixed = T))
abilities_2018[, `O.NET.SOC.Code` := `O*NET-SOC.Code`]
abilities <- rbindlist(list(abilities_2009, abilities_2013, abilities_2018), fill = T)
abilities <- abilities[, .(O.NET.SOC.Code, Element.Name, Scale.ID, Data.Value, Standard.Error, year)]
abilities[, Element.Name := paste0("abl_", Element.Name)]

# add knowledge
knowledge_2009 <- read.delim('../ref/db_14_0 2009.7/Knowledge.txt') %>% data.table()
knowledge_2013 <-  read.delim('../ref/db_18_0_2013.7/Knowledge.txt') %>% data.table()
knowledge_2018 <- read_excel("../ref/db_22_2_excel 2018.2/Knowledge.xlsx") %>% data.table()
knowledge_2009[, year := 2009]
knowledge_2013[, year := 2013]
knowledge_2018[, year := 2018]
setnames(knowledge_2018, names(knowledge_2018), gsub(" ", ".", names(knowledge_2018), fixed = T))
knowledge_2018[, `O.NET.SOC.Code` := `O*NET-SOC.Code`]
knowledge <- rbindlist(list(knowledge_2009, knowledge_2013, knowledge_2018), fill = T)
knowledge <- knowledge[, .(O.NET.SOC.Code, Element.Name, Scale.ID, Data.Value, Standard.Error, year)]
knowledge[, Element.Name := paste0("knl_", Element.Name)]

# add work activities
workactivities_2009 <- read.delim('../ref/db_14_0 2009.7/Work Activities.txt') %>% data.table()
workactivities_2013 <-  read.delim('../ref/db_18_0_2013.7/Work Activities.txt') %>% data.table()
workactivities_2018 <- read_excel("../ref/db_22_2_excel 2018.2/Work Activities.xlsx") %>% data.table()
workactivities_2009[, year := 2009]
workactivities_2013[, year := 2013]
workactivities_2018[, year := 2018]
setnames(workactivities_2018, names(workactivities_2018), gsub(" ", ".", names(workactivities_2018), fixed = T))
workactivities_2018[, `O.NET.SOC.Code` := `O*NET-SOC.Code`]
workactivities <- rbindlist(list(workactivities_2009, workactivities_2013, workactivities_2018), fill = T)
workactivities <- workactivities[, .(O.NET.SOC.Code, Element.Name, Scale.ID, Data.Value, Standard.Error, year)]
workactivities[, Element.Name := paste0("act_", Element.Name)]

# add work styles
workstyles_2009 <- read.delim('../ref/db_14_0 2009.7/Work Styles.txt') %>% data.table()
workstyles_2013 <-  read.delim('../ref/db_18_0_2013.7/Work Styles.txt') %>% data.table()
workstyles_2018 <- read_excel("../ref/db_22_2_excel 2018.2/Work Styles.xlsx") %>% data.table()
workstyles_2009[, year := 2009]
workstyles_2013[, year := 2013]
workstyles_2018[, year := 2018]
setnames(workstyles_2018, names(workstyles_2018), gsub(" ", ".", names(workstyles_2018), fixed = T))
workstyles_2018[, `O.NET.SOC.Code` := `O*NET-SOC.Code`]
workstyles <- rbindlist(list(workstyles_2009, workstyles_2013, workstyles_2018), fill = T)
workstyles <- workstyles[, .(O.NET.SOC.Code, Element.Name, Scale.ID, Data.Value, Standard.Error, year)]
workstyles[, Element.Name := paste0("sty_", Element.Name)]

#
skills <- rbindlist(list(skills, knowledge, abilities, workstyles, workactivities), fill = T)

# standardize
skills[Scale.ID == "LV", Data.Value := Data.Value/7]
skills[Scale.ID == "IM", Data.Value := (Data.Value-1)/4]
skills[Element.Name %like% "sty", Scale.ID := "LV"]
#
skills <- skills[Scale.ID == "LV"]
# reformate onet codes to merge
skills[, OCCSOC := gsub("-", "", substr(O.NET.SOC.Code,1,7))]
skills <- skills[,.(Data.Value = mean(Data.Value),
                    Standard.Error = mean(as.numeric(Standard.Error))), by = .(Element.Name,Scale.ID, OCCSOC)]

# chack to see which occ codes are missing
occ_xwalk[!OCCSOC %in% unique(skills$OCCSOC), unique(OCCSOC)]

# 
skills[, Element.Name := paste0(Element.Name, ".", Scale.ID)]
skills[,Data.Value := percent_rank(Data.Value), by = .(Element.Name, Scale.ID)]
skills <- skills[OCCSOC != 152091]
skills_wide <- dcast(skills, OCCSOC   ~Element.Name, value.var = "Data.Value")
res.pca <- prcomp(skills_wide[,-1], scale = TRUE, center = T)

# skills wide
skills_sum <- skills_wide
skills_sum[, pc1 := predict(res.pca, newdata = .SD)[,1], .SDcols = names(skills_sum)]
skills_sum[, pc2 := predict(res.pca, newdata = .SD)[,2], .SDcols = names(skills_sum)]
skills_sum[, pc3 := predict(res.pca, newdata = .SD)[,3], .SDcols = names(skills_sum)]
skills_sum[, pc4 := predict(res.pca, newdata = .SD)[,4], .SDcols = names(skills_sum)]
skills_sum[, pc5 := predict(res.pca, newdata = .SD)[,5], .SDcols = names(skills_sum)]
skills_sum[, pc6 := predict(res.pca, newdata = .SD)[,6], .SDcols = names(skills_sum)]
skills_sum[, pc7 := predict(res.pca, newdata = .SD)[,7], .SDcols = names(skills_sum)]
skills_sum[, pc8 := predict(res.pca, newdata = .SD)[,8], .SDcols = names(skills_sum)]
skills_sum[, pc9 := predict(res.pca, newdata = .SD)[,9], .SDcols = names(skills_sum)]
skills_sum[, pc10 := predict(res.pca, newdata = .SD)[,10], .SDcols = names(skills_sum)]
skills_sum[, pc11 := predict(res.pca, newdata = .SD)[,11], .SDcols = names(skills_sum)]
skills_sum[, pc12 := predict(res.pca, newdata = .SD)[,12], .SDcols = names(skills_sum)]
skills_sum[, pc13 := predict(res.pca, newdata = .SD)[,13], .SDcols = names(skills_sum)]
skills_sum[, pc14 := predict(res.pca, newdata = .SD)[,14], .SDcols = names(skills_sum)]
skills_sum[, pc15 := predict(res.pca, newdata = .SD)[,15], .SDcols = names(skills_sum)]
skills_sum[, pc16 := predict(res.pca, newdata = .SD)[,16], .SDcols = names(skills_sum)]
skills_sum[, pc17 := predict(res.pca, newdata = .SD)[,17], .SDcols = names(skills_sum)]
skills_sum[, pc18 := predict(res.pca, newdata = .SD)[,18], .SDcols = names(skills_sum)]
skills_sum[, pc19 := predict(res.pca, newdata = .SD)[,19], .SDcols = names(skills_sum)]
skills_sum[, pc20 := predict(res.pca, newdata = .SD)[,20], .SDcols = names(skills_sum)]
skills_sum[, pc21 := predict(res.pca, newdata = .SD)[,21], .SDcols = names(skills_sum)]
skills_sum[, pc22 := predict(res.pca, newdata = .SD)[,22], .SDcols = names(skills_sum)]
skills_sum[, pc23 := predict(res.pca, newdata = .SD)[,23], .SDcols = names(skills_sum)]
skills_sum[, pc24 := predict(res.pca, newdata = .SD)[,24], .SDcols = names(skills_sum)]
skills_sum[, pc25 := predict(res.pca, newdata = .SD)[,25], .SDcols = names(skills_sum)]

# skills_sum[, skl_tech_skill.LV := skl_Programming.LV + `skl_Complex Problem Solving.LV` +
#              `skl_Mathematics.LV`  + skl_Science.LV + `skl_Systems Analysis.LV` + 
#              skl_Troubleshooting.LV]
# skills_sum[, skl_tech_skill.IM := skl_Programming.IM + `skl_Complex Problem Solving.IM` +
#              `skl_Mathematics.IM`  + skl_Science.IM + `skl_Systems Analysis.IM` + 
#              skl_Troubleshooting.IM]
skills_sum[, average_value_skills := rowMeans(.SD), .SDcols = rownames(res.pca$rotation)[rownames(res.pca$rotation) %like% "LV" & rownames(res.pca$rotation) %like% "skl"]]
skills_sum[, average_value_abilities := rowMeans(.SD), .SDcols = rownames(res.pca$rotation)[rownames(res.pca$rotation) %like% "LV" & rownames(res.pca$rotation) %like% "abl"]]
skills_sum[, average_value_knowledge := rowMeans(.SD), .SDcols = rownames(res.pca$rotation)[rownames(res.pca$rotation) %like% "LV" & rownames(res.pca$rotation) %like% "knl"]]
skills_sum[, average_value_workstyles := rowMeans(.SD), .SDcols = rownames(res.pca$rotation)[rownames(res.pca$rotation) %like% "LV" & rownames(res.pca$rotation) %like% "sty"]]
skills_sum[, average_value_activities := rowMeans(.SD), .SDcols = rownames(res.pca$rotation)[rownames(res.pca$rotation) %like% "LV" & rownames(res.pca$rotation) %like% "act"]]

skills_sum <- merge(skills_sum, occ_xwalk, by = "OCCSOC")


# collapse to OCCSOC
vars <- names(skills_wide)[-1]
skills_final <- skills_sum[,lapply(.SD, mean), .SDcols = vars, by = .(`CPS Code`, `CPS Occupational Title`)]
acs[, OCC2010 := as.character(OCC2010)]

#standardize occ2010 to match occ2019
#this is due to a problem with the occ2010 var where a bunch of occs
#shift from one occ to another in 2005, which doesn't happen in the occ
#2019 var
acs[,.(OCC2010, OCC1990)] %>% unique -> temp
temp <- temp[!duplicated(temp$OCC2010)]
skills_final <- merge(skills_final, temp, by.x = "CPS Code", by.y = "OCC2010", all.x = T)
vars_temp <- names(skills_final)[!names(skills_final) %like% "CPS|OCC"]
skills_final[, (vars_temp) := lapply(.SD, mean, na.rm = T), by = OCC1990, .SDcols = vars_temp]
skills_final[,OCC1990 := NULL]

#clean up memory
rm(list = ls()[!ls() %in% c("acs", "vars", "weighted.var", "skills_final", "res.pca")])
```


# Introduction

## Add Work styles and activities, perform pca

```{r}

fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE ,
             select.var = list(contrib = 15)    # Avoid text overlapping
)
fviz_pca_var(res.pca,
             axes = c(3,4),
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,# Avoid text overlapping,
             select.var = list(contrib = 15)
)

```

## Use PCA to perform K means clustering

```{r}
skills_final[, OCC2010 := `CPS Code`]
df <- skills_final[!duplicated(skills_final$OCC2010), .SD, .SDcols = names(skills_final)[names(skills_final) %like% "skl|knl|abl|act|sty|pc|OCC2010" & names(skills_final) %like% "pc|OCC2010"]]
df_occ <- df[,OCC2010]
df[, OCC2010 := NULL]
df <- df[,.(pc1, pc2, pc3, pc4, pc5, pc6, pc7, pc8, pc9, pc10, pc11, pc12, pc13, pc14, pc15, pc16, pc17,
            pc18, pc19, pc20, pc21, pc22, pc23, pc24, pc25)]


optr <- function(k){
  stats::kmeans(df, centers = k) -> temp2
  return(data.table(k =k, tot_withinss = temp2$tot.withinss))
}

lapply(1:250, optr) %>% rbindlist -> optr_out
ggplot(optr_out) + 
  geom_point(aes(x = k, y = tot_withinss))

```



```{r}


c(4,9,67,120) -> k_cand
acs[, OCC10LY := as.character(OCC10LY)]

for(k in k_cand){
  stats::kmeans(df, centers = k) -> temp2
  df_temp2 <- data.table(OCC2010 = df_occ, kmeans_cluster = temp2$cluster)
  setnames(df_temp2, "kmeans_cluster", paste0("kmeans_cluster_", k, "_current"))
  df_temp2[, paste0("kmeans_cluster_", k, "_current") := paste0(",", get(paste0("kmeans_cluster_", k, "_current")), 
                                                                ",")]
  acs <- merge(acs, df_temp2, by = "OCC2010")
  
  df_temp3 <- data.table(OCC10LY = df_occ, kmeans_cluster = temp2$cluster)
  setnames(df_temp3, "kmeans_cluster", paste0("kmeans_cluster_", k, "_ly"))
  df_temp3[, paste0("kmeans_cluster_", k, "_ly") := paste0(",", get(paste0("kmeans_cluster_", k, "_ly")), 
                                                           ",")]
  
  acs <- merge(acs, df_temp3, by = "OCC10LY")
  
  
  centers <- temp2$centers
  
  melt(centers) %>% data.table() %>% .[,.(value = value[Var2 == "pc1"]), by = Var1] %>% .[order(value, decreasing = T), Var1] %>% .[1] -> high_skill
  
  centers_long <- melt(centers)
  centers_long <- data.table(centers_long)
  centers_long[, Var1 := paste0(",", Var1, ",")]
  centers_long <- merge(centers_long, centers_long, by = "Var2", allow.cartesian = T)
  centers_dist <- data.table(centers_long)[,.(geo_mean_dist = mean(abs(value.x - value.y))),
                                           by = .(Var1.x, Var1.y)]
  setnames(centers_dist, c(paste0("kmeans_cluster_", k, "_current"), 
                           paste0("kmeans_cluster_", k, "_ly"), paste0("geo_means_", k, "_dist")))
  
  # create vectors of nearest neighbors
  for(k_temp in paste0(",", 1:k, ",")){
    centers_dist[get(paste0("kmeans_cluster_", k, "_ly")) == k_temp] %>% 
      .[order(get(paste0("geo_means_", k, "_dist")))] %>%
      .[,get(paste0("kmeans_cluster_", k, "_current"))] %>% 
      .[1:3] %>% 
      paste0(., collapse = "|") -> tempp
    centers_dist[get(paste0("kmeans_cluster_", k, "_ly")) == k_temp,
                 paste0("kmeans_cluster_rank_3_", k, "_conc"):= 
                   ifelse(get(paste0("kmeans_cluster_", k, "_current")) %like% tempp, 1,0) ]
  }
  
  
  
  #
  acs <- merge(acs, centers_dist, by = c(paste0("kmeans_cluster_", k, "_current"),
                                         paste0("kmeans_cluster_", k, "_ly")))
  centers_dist[,   paste0("kmeans_cluster_", k, "_ly") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_cluster_", k, "_ly"))))]
  centers_dist[,   paste0("kmeans_cluster_", k, "_current") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_cluster_", k, "_current"))))]
  acs[,   paste0("kmeans_cluster_", k, "_ly") :=
        as.numeric(gsub(",", "", get(  paste0("kmeans_cluster_", k, "_ly"))))]
  acs[,   paste0("kmeans_cluster_", k, "_current") := 
        as.numeric(gsub(",", "", get(  paste0("kmeans_cluster_", k, "_current"))))]
  
  acs[,paste0("kmeans_cluster_", k, "_conc") := ifelse(get(paste0("kmeans_cluster_", k, "_current")) == 
                                                         get(paste0("kmeans_cluster_", k, "_ly")),1,0)]
  
  acs[, paste0("source_kmeans_", k, "_N") := .N, by = get(paste0("kmeans_cluster_", k, "_ly"))]
  
  acs[, paste0("kmeans_cluster_", k, "_current") := factor(get(paste0("kmeans_cluster_", k, "_current")), 
                                                           levels = centers_dist[get(paste0("kmeans_cluster_", k, "_current")) == high_skill] %>%
                                                             .[order(get(paste0("geo_means_", k, "_dist")))] %>%
                                                             .[,get(paste0("kmeans_cluster_", k, "_ly"))])]
  acs[, paste0("kmeans_cluster_", k, "_ly") := factor(get(paste0("kmeans_cluster_", k, "_ly")), 
                                                      levels = centers_dist[get(paste0("kmeans_cluster_", k, "_current")) == high_skill] %>%
                                                        .[order(get(paste0("geo_means_", k, "_dist")))] %>%
                                                        .[,get(paste0("kmeans_cluster_", k, "_ly"))])]
  
  
  
  
}



```



### Try nested k means


```{r}

c(120, 67, 9, 4) -> k_cand
acs[, OCC10LY := as.character(OCC10LY)]

for(k in k_cand[1]){
  stats::kmeans(df, centers = k, iter.max = 30) -> temp2
  df_temp2 <- data.table(OCC2010 = df_occ, kmeans_nested_cluster = temp2$cluster)
  setnames(df_temp2, "kmeans_nested_cluster", paste0("kmeans_nested_cluster_", k, "_current"))
  df_temp2[, paste0("kmeans_nested_cluster_", k, "_current") := paste0(",", get(paste0("kmeans_nested_cluster_", k, "_current")), 
                                                                       ",")]
  acs <- merge(acs, df_temp2, by = "OCC2010")
  
  df_temp3 <- data.table(OCC10LY = df_occ, kmeans_nested_cluster = temp2$cluster)
  setnames(df_temp3, "kmeans_nested_cluster", paste0("kmeans_nested_cluster_", k, "_ly"))
  df_temp3[, paste0("kmeans_nested_cluster_", k, "_ly") := paste0(",", get(paste0("kmeans_nested_cluster_", k, "_ly")), 
                                                                  ",")]
  
  acs <- merge(acs, df_temp3, by = "OCC10LY")
  
  
  centers <- temp2$centers
  
  melt(centers) %>% data.table() %>% .[,.(value = value[Var2 == "pc1"]), by = Var1] %>% .[order(value, decreasing = T), Var1] %>% .[1] -> high_skill
  
  centers_long <- melt(centers)
  centers_long <- data.table(centers_long)
  centers_long[, Var1 := paste0(",", Var1, ",")]
  centers_long <- merge(centers_long, centers_long, by = "Var2", allow.cartesian = T)
  centers_dist <- data.table(centers_long)[,.(geo_mean_dist = mean(abs(value.x - value.y))),
                                           by = .(Var1.x, Var1.y)]
  setnames(centers_dist, c(paste0("kmeans_nested_cluster_", k, "_current"), 
                           paste0("kmeans_nested_cluster_", k, "_ly"), paste0("geo_nested_means_", k, "_dist")))
  
  # create vectors of nearest neighbors
  for(k_temp in paste0(",", 1:k, ",")){
    centers_dist[get(paste0("kmeans_nested_cluster_", k, "_ly")) == k_temp] %>% 
      .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
      .[,get(paste0("kmeans_nested_cluster_", k, "_current"))] %>% 
      .[1:3] %>% 
      paste0(., collapse = "|") -> tempp
    centers_dist[get(paste0("kmeans_nested_cluster_", k, "_ly")) == k_temp,
                 paste0("kmeans_nested_cluster_rank_3_", k, "_conc"):= 
                   ifelse(get(paste0("kmeans_nested_cluster_", k, "_current")) %like% tempp, 1,0) ]
  }
  
  
  
  #
  acs <- merge(acs, centers_dist, by = c(paste0("kmeans_nested_cluster_", k, "_current"),
                                         paste0("kmeans_nested_cluster_", k, "_ly")))
  centers_dist[,   paste0("kmeans_nested_cluster_", k, "_ly") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_ly"))))]
  centers_dist[,   paste0("kmeans_nested_cluster_", k, "_current") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_current"))))]
  acs[,   paste0("kmeans_nested_cluster_", k, "_ly") :=
        as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_ly"))))]
  acs[,   paste0("kmeans_nested_cluster_", k, "_current") := 
        as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_current"))))]
  
  acs[,paste0("kmeans_nested_cluster_", k, "_conc") := ifelse(get(paste0("kmeans_nested_cluster_", k, "_current")) == 
                                                                get(paste0("kmeans_nested_cluster_", k, "_ly")),1,0)]
  
  acs[, paste0("source_kmeans_nested_", k, "_N") := .N, by = get(paste0("kmeans_nested_cluster_", k, "_ly"))]
  
  acs[, paste0("kmeans_nested_cluster_", k, "_current") := factor(get(paste0("kmeans_nested_cluster_", k, "_current")), 
                                                                  levels = centers_dist[get(paste0("kmeans_nested_cluster_", k, "_current")) == high_skill] %>%
                                                                    .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
                                                                    .[,get(paste0("kmeans_nested_cluster_", k, "_ly"))])]
  acs[, paste0("kmeans_nested_cluster_", k, "_ly") := factor(get(paste0("kmeans_nested_cluster_", k, "_ly")), 
                                                             levels = centers_dist[get(paste0("kmeans_nested_cluster_", k, "_current")) == high_skill] %>%
                                                               .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
                                                               .[,get(paste0("kmeans_nested_cluster_", k, "_ly"))])]
  
}

df <- temp2$centers
df_occ <- rownames(temp2$centers)

for(i in 2:4){
  k <- k_cand[i]
  k_prev <- k_cand[(i - 1)]
  stats::kmeans(df, centers = k, iter.max = 30) -> temp2
  df_temp2 <- data.table(OCC2010 = df_occ, kmeans_nested_cluster = temp2$cluster)
  setnames(df_temp2, "kmeans_nested_cluster", paste0("kmeans_nested_cluster_", k, "_current"))
  setnames(df_temp2, "OCC2010", paste0("kmeans_nested_cluster_", k_prev, "_current"))
  
  df_temp2[, paste0("kmeans_nested_cluster_", k, "_current") := paste0(",", get(paste0("kmeans_nested_cluster_", k, "_current")), 
                                                                       ",")]
  df_temp2[,  paste0("kmeans_nested_cluster_", k_prev, "_current") := factor(get( paste0("kmeans_nested_cluster_", k_prev, "_current")), levels = acs[,levels(get( paste0("kmeans_nested_cluster_", k_prev, "_current")))])]
  acs <- merge(acs, df_temp2, by =  paste0("kmeans_nested_cluster_", k_prev, "_current"))
  
  df_temp3 <- data.table(OCC10LY = df_occ, kmeans_nested_cluster = temp2$cluster)
  setnames(df_temp3, "kmeans_nested_cluster", paste0("kmeans_nested_cluster_", k, "_ly"))
  setnames(df_temp3, "OCC10LY", paste0("kmeans_nested_cluster_", k_prev, "_ly"))
  
  df_temp3[, paste0("kmeans_nested_cluster_", k, "_ly") := paste0(",", get(paste0("kmeans_nested_cluster_", k, "_ly")), 
                                                                  ",")]
  df_temp3[,  paste0("kmeans_nested_cluster_", k_prev, "_ly") := factor(get( paste0("kmeans_nested_cluster_", k_prev, "_ly")), levels = acs[,levels(get( paste0("kmeans_nested_cluster_", k_prev, "_current")))])]
  
  acs <- merge(acs, df_temp3, by = paste0("kmeans_nested_cluster_", k_prev, "_ly"))
  
  
  centers <- temp2$centers
  
  melt(centers) %>% data.table() %>% .[,.(value = value[Var2 == "pc1"]), by = Var1] %>% .[order(value, decreasing = T), Var1] %>% .[1] -> high_skill
  
  centers_long <- melt(centers)
  centers_long <- data.table(centers_long)
  centers_long[, Var1 := paste0(",", Var1, ",")]
  centers_long <- merge(centers_long, centers_long, by = "Var2", allow.cartesian = T)
  centers_dist <- data.table(centers_long)[,.(geo_mean_dist = mean(abs(value.x - value.y))),
                                           by = .(Var1.x, Var1.y)]
  setnames(centers_dist, c(paste0("kmeans_nested_cluster_", k, "_current"), 
                           paste0("kmeans_nested_cluster_", k, "_ly"), paste0("geo_nested_means_", k, "_dist")))
  
  # create vectors of nearest neighbors
  for(k_temp in paste0(",", 1:k, ",")){
    centers_dist[get(paste0("kmeans_nested_cluster_", k, "_ly")) == k_temp] %>% 
      .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
      .[,get(paste0("kmeans_nested_cluster_", k, "_current"))] %>% 
      .[1:3] %>% 
      paste0(., collapse = "|") -> tempp
    centers_dist[get(paste0("kmeans_nested_cluster_", k, "_ly")) == k_temp,
                 paste0("kmeans_nested_cluster_rank_3_", k, "_conc"):= 
                   ifelse(get(paste0("kmeans_nested_cluster_", k, "_current")) %like% tempp, 1,0) ]
  }
  
  
  
  #
  acs <- merge(acs, centers_dist, by = c(paste0("kmeans_nested_cluster_", k, "_current"),
                                         paste0("kmeans_nested_cluster_", k, "_ly")))
  centers_dist[,   paste0("kmeans_nested_cluster_", k, "_ly") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_ly"))))]
  centers_dist[,   paste0("kmeans_nested_cluster_", k, "_current") := 
                 as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_current"))))]
  acs[,   paste0("kmeans_nested_cluster_", k, "_ly") :=
        as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_ly"))))]
  acs[,   paste0("kmeans_nested_cluster_", k, "_current") := 
        as.numeric(gsub(",", "", get(  paste0("kmeans_nested_cluster_", k, "_current"))))]
  
  acs[,paste0("kmeans_nested_cluster_", k, "_conc") := ifelse(get(paste0("kmeans_nested_cluster_", k, "_current")) == 
                                                                get(paste0("kmeans_nested_cluster_", k, "_ly")),1,0)]
  
  acs[, paste0("source_kmeans_nested_", k, "_N") := .N, by = get(paste0("kmeans_nested_cluster_", k, "_ly"))]
  
  acs[, paste0("kmeans_nested_cluster_", k, "_current") := factor(get(paste0("kmeans_nested_cluster_", k, "_current")), 
                                                                  levels = centers_dist[get(paste0("kmeans_nested_cluster_", k, "_current")) == high_skill] %>%
                                                                    .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
                                                                    .[,get(paste0("kmeans_nested_cluster_", k, "_ly"))])]
  acs[, paste0("kmeans_nested_cluster_", k, "_ly") := factor(get(paste0("kmeans_nested_cluster_", k, "_ly")), 
                                                             levels = centers_dist[get(paste0("kmeans_nested_cluster_", k, "_current")) == high_skill] %>%
                                                               .[order(get(paste0("geo_nested_means_", k, "_dist")))] %>%
                                                               .[,get(paste0("kmeans_nested_cluster_", k, "_ly"))])]
  
  df <- temp2$centers
  df_occ <- rownames(temp2$centers)
  
}

### do some post processing to relabel the nested groups to make that more apparent
### 120
levels(acs$kmeans_nested_cluster_120_ly) -> levs
acs[, kmeans_nested_cluster_120_ly := paste(kmeans_nested_cluster_4_ly, kmeans_nested_cluster_9_ly,
                                            kmeans_nested_cluster_67_ly,kmeans_nested_cluster_120_ly, sep = "_")]
unique(acs$kmeans_nested_cluster_120_ly) %>% 
  tstrsplit(., "_", keep = 4) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_120_ly := factor(kmeans_nested_cluster_120_ly, levels = 
                                               unique(acs$kmeans_nested_cluster_120_ly)[temp] )]

levels(acs$kmeans_nested_cluster_120_current) -> levs
acs[, kmeans_nested_cluster_120_current := paste(kmeans_nested_cluster_4_current, kmeans_nested_cluster_9_current,
                                                 kmeans_nested_cluster_67_current, kmeans_nested_cluster_120_current, sep = "_")]
unique(acs$kmeans_nested_cluster_120_current) %>% 
  tstrsplit(., "_", keep = 4) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_120_current := factor(kmeans_nested_cluster_120_current, levels = 
                                                    unique(acs$kmeans_nested_cluster_120_current)[temp] )]
### 67
levels(acs$kmeans_nested_cluster_67_ly) -> levs
acs[, kmeans_nested_cluster_67_ly := paste(kmeans_nested_cluster_4_ly, kmeans_nested_cluster_9_ly,
                                           kmeans_nested_cluster_67_ly, sep = "_")]
unique(acs$kmeans_nested_cluster_67_ly) %>% 
  tstrsplit(., "_", keep = 3) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_67_ly := factor(kmeans_nested_cluster_67_ly, levels = 
                                              unique(acs$kmeans_nested_cluster_67_ly)[temp] )]

levels(acs$kmeans_nested_cluster_67_current) -> levs
acs[, kmeans_nested_cluster_67_current := paste(kmeans_nested_cluster_4_current, kmeans_nested_cluster_9_current,
                                                kmeans_nested_cluster_67_current, sep = "_")]
unique(acs$kmeans_nested_cluster_67_current) %>% 
  tstrsplit(., "_", keep = 3) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_67_current := factor(kmeans_nested_cluster_67_current, levels = 
                                                   unique(acs$kmeans_nested_cluster_67_current)[temp] )]

### 9
levels(acs$kmeans_nested_cluster_9_ly) -> levs
acs[, kmeans_nested_cluster_9_ly := paste(kmeans_nested_cluster_4_ly,
                                          kmeans_nested_cluster_9_ly, sep = "_")]
unique(acs$kmeans_nested_cluster_9_ly) %>% 
  tstrsplit(., "_", keep =2) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_9_ly := factor(kmeans_nested_cluster_9_ly, levels = 
                                             unique(acs$kmeans_nested_cluster_9_ly)[temp] )]

levels(acs$kmeans_nested_cluster_9_current) -> levs
acs[, kmeans_nested_cluster_9_current := paste(kmeans_nested_cluster_4_current,
                                               kmeans_nested_cluster_9_current, sep = "_")]
unique(acs$kmeans_nested_cluster_9_current) %>% 
  tstrsplit(., "_", keep = 2) %>% 
  .[[1]] %>% 
  match(levs, .) -> temp
acs[, kmeans_nested_cluster_9_current := factor(kmeans_nested_cluster_9_current, levels = 
                                                  unique(acs$kmeans_nested_cluster_9_current)[temp] )]



```

### Sort by loading on PC1 (highest values) to the right, which means lowest skills to the right

```{r}


for(k in k_cand){
  acs[OCC90LY != OCC1990,.(N = .N, source_kmeans_N = unique(get(paste0("source_kmeans_nested_", k, "_N") ))),
      by= .(get(paste0("kmeans_nested_cluster_", k, "_current")), get(paste0("kmeans_nested_cluster_", k, "_ly")))] %>% 
    .[, total := sum(N), by = get.1] %>% 
    .[, prop := N/total] %>% 
    .[N >= 10] %>% 
    ggplot() + 
    geom_point(aes(y = get,
                   x = get.1, color = N, size = prop), shape = 1, stroke = 1) + 
    scale_color_viridis_c(trans = "log10", direction = -1) +
    scale_radius()+
    geom_abline(yintercept = 0, slope = 1, color= "red") +
    theme(axis.text.x = element_text(angle = 90), 
          axis.text = element_text(size = 5)) + 
    scale_x_discrete(drop = F)+
    scale_y_discrete(drop = F) +
    ggtitle(paste0("K = ", k))-> gg
  print(gg)
}
```

### Recreate graphs sorted by class first

```{r}


for(k in k_cand){
  levs <- acs[, levels(get(paste0("kmeans_nested_cluster_", k, "_current")))]
  acs[OCC90LY != OCC1990,.(N = .N, source_kmeans_N = unique(get(paste0("source_kmeans_nested_", k, "_N") ))),
      by= .(get(paste0("kmeans_nested_cluster_", k, "_current")), get(paste0("kmeans_nested_cluster_", k, "_ly")))] %>% 
    .[, total := sum(N), by = get.1] %>% 
    .[, prop := N/total] %>% 
    .[N >= 10] %>% 
    .[, get := as.character(get)] %>% 
    .[, get.1 := as.character(get.1)] %>% 
    
    ggplot() + 
    geom_point(aes(y = get,
                   x = get.1, color = N, size = prop), shape = 1, stroke = 1) + 
    scale_color_viridis_c(trans = "log10", direction = -1) +
    scale_radius()+
    geom_abline(yintercept = 0, slope = 1, color= "red") +
    theme(axis.text.x = element_text(angle = 90), 
          axis.text = element_text(size = 5)) + 
    scale_x_discrete(breaks = levs, labels = levs, limits = sort(levs), drop = F)+
    scale_y_discrete(breaks = levs, labels = levs, limits = sort(levs), drop = F)+
    ggtitle(paste0("K = ", k))-> gg
  print(gg)
}

k <- 67
levs <- acs[, levels(get(paste0("kmeans_nested_cluster_", k, "_current")))]
dt <- data.table(x = sort(levs))
dt <- cbind(dt, dt[,tstrsplit(x, "_")])
dt1 <- dt[,.(minx = min(x), 
             maxx = max(x)), by = V1]
dt2 <- dt[,.(minx = min(x), 
             maxx = max(x)), by = V2]

acs[OCC90LY != OCC1990,.(N = .N, source_kmeans_N = unique(get(paste0("source_kmeans_nested_", k, "_N") ))),
    by= .(get(paste0("kmeans_nested_cluster_", k, "_current")), get(paste0("kmeans_nested_cluster_", k, "_ly")))] %>% 
  .[, total := sum(N), by = get.1] %>% 
  .[, prop := N/total] %>% 
  .[N >= 10] %>% 
  .[, get := as.character(get)] %>% 
  .[, get.1 := as.character(get.1)] %>% 
  
  ggplot() + 
  geom_point(aes(y = get,
                 x = get.1, color = N, size = prop), shape = 1, stroke = 1) + 
  scale_color_viridis_c(trans = "log10", direction = -1) +
  scale_radius()+
  geom_abline(yintercept = 0, slope = 1, color= "red") +
  theme(axis.text.x = element_text(angle = 90), 
        axis.text = element_text(size = 5)) + 
  scale_x_discrete(breaks = levs, labels = levs, limits = sort(levs), drop = F)+
  scale_y_discrete(breaks = levs, labels = levs, limits = sort(levs), drop = F)+
  ggtitle(paste0("K = ", k)) +
  geom_rect(data = dt1, aes(xmin = minx, ymin = minx, ymax = maxx, xmax = maxx), color = "blue", fill = NA) + 
    geom_rect(data = dt2, aes(xmin = minx, ymin = minx, ymax = maxx, xmax = maxx), color = "red", fill = NA) -> gg
print(gg)
```

### Distance, defined as the mean of the absolute differences in all PC variables between microclasses (unitless scale)

```{r}
for(k in k_cand){
  ggplot(acs[OCC90LY != OCC1990])+
    geom_density(aes(x = get(paste0("geo_nested_means_", k, "_dist")))) + 
    ggtitle(paste0("K = ", k)) -> gg
  print(gg)
}

```

###

```{r, results = 'asis'}
acs[,.(OCC2010, kmeans_nested_cluster_120_current, kmeans_nested_cluster_67_current, kmeans_nested_cluster_9_current, kmeans_nested_cluster_4_current)] %>% unique() -> jobs
jobs <- merge(jobs, skills_final[,.(`CPS Occupational Title`, `CPS Code`)], 
              by.x = "OCC2010", by.y = "CPS Code")
jobs[, `CPS Occupational Title` := substr(`CPS Occupational Title`,1,30)]
jobs <- jobs[jobs[order(kmeans_nested_cluster_4_current, 
                        kmeans_nested_cluster_9_current, kmeans_nested_cluster_67_current, kmeans_nested_cluster_120_current)],
             .(`CPS Occupational Title`, kmeans_nested_cluster_120_current,
               kmeans_nested_cluster_67_current, kmeans_nested_cluster_9_current,
               kmeans_nested_cluster_4_current)]
setnames(jobs, c("Title", "Class_120", "Class_67", "Class_9", "Class_4"))

for(i in 1:ceiling(nrow(jobs)/50)){
  cat("\n") 
  cat("###", i, "\n") # Create second level headings with the names.
  
  print(
    xtable::xtable(jobs[(0 + (50 * (i - 1))):(1 + (50 * (i)))])
  )
  
  cat("\n")
}
```


# Use constructed classes to evaluate correspondance with wages

```{r}
library(ggridges)
ggplot(acs[log_incwage <= 13 & log_incwage >= 7.5]) + 
  geom_density(aes(x = log_incwage)) + 
  facet_wrap(~ kmeans_nested_cluster_4_current)

ggplot(acs, 
  aes(x = log_incwage, y = kmeans_nested_cluster_67_current)
) +
  geom_density_ridges_gradient(
    aes(fill = ..x..), scale = 3, size = 0.3
  ) +
  scale_fill_gradientn(
    colours = c("#0D0887FF", "#CC4678FF", "#F0F921FF"),
    name = "Log (Wage)"
  ) + 
  xlim(7.5, 13)

acs_temp <- NULL
```

## See how incwage tracks with skills

```{r}
acs <- merge(acs, skills_final, by = "OCC2010")

acs[sample(nrow(acs), 1000), .(pc1, pc2, pc3, pc4, log_incwage)] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1) +
  facet_wrap(~variable)

acs[sample(nrow(acs), 1000), .( average_value_abilities, average_value_knowledge, average_value_skills,average_value_workstyles, average_value_activities, log_incwage)] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1) +
  facet_wrap(~variable)

acs[sample(nrow(acs), 1000), .SD, .SDcols = names(acs)[names(acs) %like% "skl|log_incwage"]] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1, alpha = .2) +
  facet_wrap(~variable) + 
  geom_smooth(aes( x= value, y = log_incwage), method = "lm", se = T) + 
  ylim(7.5, 13) + 
  ggtitle("Skills & Log(Income)")

acs[sample(nrow(acs), 1000), .SD, .SDcols = names(acs)[names(acs) %like% "abl|log_incwage"]] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1, alpha = .2) +
  facet_wrap(~variable) + 
  geom_smooth(aes( x= value, y = log_incwage), method = "lm", se = T) + 
  ylim(7.5, 13) + 
  ggtitle("Abilities & Log(Income)")

acs[sample(nrow(acs), 1000), .SD, .SDcols = names(acs)[names(acs) %like% "knl|log_incwage"]] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1, alpha = .2) +
  facet_wrap(~variable) + 
  geom_smooth(aes( x= value, y = log_incwage), method = "lm", se = T) + 
  ylim(7.5, 13) + 
  ggtitle("Knowledge & Log(Income)")

acs[sample(nrow(acs), 1000), .SD, .SDcols = names(acs)[names(acs) %like% "act|log_incwage"]] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1, alpha = .2) +
  facet_wrap(~variable) + 
  geom_smooth(aes( x= value, y = log_incwage), method = "lm", se = T) + 
  ylim(7.5, 13) + 
  ggtitle("Work Activities & Log(Income)")

acs[sample(nrow(acs), 1000), .SD, .SDcols = names(acs)[names(acs) %like% "sty|log_incwage"]] %>% melt(., id.var = "log_incwage") %>% 
  ggplot() + 
  geom_point(aes(x = value, y = log_incwage), shape = 1, alpha = .2) +
  facet_wrap(~variable) + 
  geom_smooth(aes( x= value, y = log_incwage), method = "lm", se = T) + 
  ylim(7.5, 13) + 
  ggtitle("Work Styles & Log(Income)")
```

## Print fitted model regressions for above graphs

```{r}
sloper <- function(c.var){
  mod <- lm(as.formula(paste0("log_incwage ~`", c.var, "`")), data = acs[sample(nrow(acs), 10000)])
  return(data.table(variable = c.var, slope = mod$coefficients[2], se = summary(mod)$coefficients[2,2], rsquared = summary(mod)$r.squared))
  
}

lapply(names(skills_final)[names(skills_final) %like% "skl|abl|knl|act_|sty||average|pc"], sloper) %>% rbindlist() -> out_dt

ggplot(out_dt[variable %like% "skl"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ skills") +
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "knl"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ knowledge")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "abl"]) + 
  geom_point(aes(y = substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ abilities")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "act"]) + 
  geom_point(aes(y =  substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ work activities")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "sty"]) + 
  geom_point(aes(y =  substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ work styles")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "average"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ Averages")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "pc"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, log_income ~ pca")+
  geom_vline(xintercept = 0, linetype = 3)
```

### Chack correspondance between predictions and other classification systems

```{r, results = "asis"}
# cheng xwalk
cheng <- data.table(readstata13::read.dta13("../ref/occ1950_mc_xwalk_70.dta"))
cheng[, occ1950 := gsub("[^A-Za-z0-9]", "", tolower(occ1950))]

# occ50 recode
occ50_recode <- fread("../ref/occ1950_recode.csv")
occ50_recode <- occ50_recode[,1:2]
names(occ50_recode) <- unlist(occ50_recode[1, ])
occ50_recode <- occ50_recode[-1,]
occ50_recode <- occ50_recode[!is.na(as.numeric(occ1950_num))]
occ50_recode[, occ1950 := gsub("[^A-Za-z0-9]", "", tolower(occ1950))]

# merge
cheng <- merge(cheng, occ50_recode[,.(occ1950, occ1950_num)], all.x = T)

#fix the stragglers
fix <- cheng[is.na(occ1950_num)]
candidates <- occ50_recode[!occ1950 %in% cheng$occ1950]

for(c.fix in 1:nrow(fix)){
  goal <- substr(fix[c.fix, occ1950],1,7)
  new <- candidates[candidates$occ1950 %like% goal, occ1950_num]
  if(length(new) == 1){fix[c.fix, new_occ1950_num := new]}
}


fix[is.na(new_occ1950_num), new_occ1950_num := c(43, 34, 44, 603, 16, 46, 605,94, 19,48,69,84,26,23,27,29)]

cheng <- merge(cheng, fix[,.(occ1950, new_occ1950_num)], by = "occ1950", all.x = T)
cheng[is.na(occ1950_num), occ1950_num := new_occ1950_num]
cheng[, occ1950_num := as.numeric(occ1950_num)]
cheng[, new_occ1950_num := NULL]
setnames(cheng, "occ1950_num", "OCC1950")
cheng[, occ1950 := NULL]

factorr <- function(x){ifelse(is.character(x), return(factor(x)), return(x))}
cheng[,names(cheng) := lapply(.SD, factorr), .SDcols = names(cheng)]


#acs <- merge(acs, cheng, by.x = "OCC1950", by.y = "occ1950_num", all.x = T)
acs <- acs[cheng, on = "OCC1950"]

setnames(acs, c("mesoocc", "macroocc", "microocc"), paste0(c("mesoocc", "macroocc", "microocc"), "_current"))

setnames(cheng, "OCC1950", "OCC50LY")

acs <- acs[cheng, on = "OCC50LY"]

setnames(acs, c("mesoocc", "macroocc", "microocc"), paste0(c("mesoocc", "macroocc", "microocc"), "_ly"))

# loop over scheme and calculate concordance
for(c.scheme in  c( "mesoocc", "macroocc", "microocc")){
  acs[,paste0(c.scheme, "_conc") := get(paste0(c.scheme, "_ly")) == get(paste0(c.scheme, "_current")) ]
}

acs <- acs[!is.na(OCC2010)]

num_correct <- acs[OCC1950 != OCC50LY & !is.na(kmeans_cluster_67_current),
                   colSums(.SD, na.rm = T), .SDcols = names(acs)[names(acs) %like% "conc"]]
total <- acs[OCC1950 != OCC50LY , nrow(.SD)]
num_correct <- num_correct/total
num_cats <- acs[OCC1950 != OCC50LY, lapply(.SD, FUN = function(x){length(unique(x))}), .SDcols = names(acs)[names(acs) %like% "occ_ly|bin_ly"]]

num_correct[names(num_correct) %like% "meso|macro|micro|4_|9_|67_"] -> out
out <- melt(out) %>% data.table(., keep.rownames = T)
out <- out[!rn %like% "rank"]
out[,id := c(1,2,3,3,2,1,2,1,3)]
out[,method := c(rep("Skills-Based", 3), 
                 rep("Nested Skills-Based",3),
                 rep("Traditional",3))]
out <- dcast(out, method ~ id)
setnames(out, c("Method", "Macro (4)", "Meso (9)", "Micro (67)"))
xtable::xtable(out)
```

# Repeat analysis on how average skills and median income change with job moves

```{r}
# merge on both new and old jobs
vars <- names(skills_final)[3:186]
skills_final[, OCC2010 := NULL]
setnames(acs, vars, paste0(vars, "_current"))
setnames(acs, "CPS Occupational Title","CPS Occupational Title_current")
# merge it all
acs[, OCC10LY := as.character(OCC10LY)]
acs <- merge(acs, skills_final, 
             all.x = T,
             by.x = "OCC10LY",
             by.y = "CPS Code")

setnames(acs, vars, paste0(vars, "_ly"))
setnames(acs, "CPS Occupational Title","CPS Occupational Title_ly")




acs[, ed_num := as.numeric(as.character(factor(educ,levels = levels(acs$educ), labels = c(0,0,0,2.5,1,2,3,4,5.5,
                                                                                          5,6,7.5, 7,8,9,10,11,11, 11, 11,12,
                                                                                          13,14,14,15,15,15,16,16,17,17,18,18,18,18,NA))))]

acs[ed_num <= 14, ed_categ := "Less than HS"]
acs[ed_num > 14, ed_categ := "College Plus"]

# subset to flows
skills_flows <- acs[OCC10LY != OCC2010]

# # graph distribution
# ggplot(skills_flows[!(OCC2010 == 4760 & OCC10LY == 4850),.SD, .SDcols = paste0(vars[!vars %like% "skills|pc"], "_distance")] %>% melt()) + 
#   geom_histogram(aes(x = value)) + 
#   facet_wrap(~variable) + 
#   xlim(0,1) + 
#   geom_abline(intercept = 2831.867, slope = -2831.867)


for(c.skill in vars){
  #acs[, paste0(c.skill, "_distance") := abs(get(paste0(c.skill, '_current')) - get(paste0(c.skill, '_ly')))]
  skills_flows[, paste0(c.skill, "_diff") := (get(paste0(c.skill, '_current')) - get(paste0(c.skill, '_ly')))]
}

# compute median income for job
skills_flows[, occ_median_log_income := median(log_incwage), by = OCC2010]
skills_flows[, occ_median_log_income_ly := median(log_incwage), by = OCC10LY]
skills_flows[, occ_median_log_inc_diff := occ_median_log_income - occ_median_log_income_ly]

skills_flows[as.numeric(whyptly) %in% 1, colMeans(.SD, na.rm = T), .SDcols = names(skills_flows)[names(skills_flows) %like% "skl|abl|knl|act|sty|inc" &
                                                                                                   names(skills_flows) %like% "diff"], by = .(year)] %>% .[,variable := rep(names(skills_flows)[names(skills_flows) %like% "skl|abl|knl|act|sty|inc" &
                                                                                                                                                                                                  names(skills_flows) %like% "diff"], 31)] %>% 
  data.table(.) %>% 
  .[, skills := (!variable %like% "log_inc")] %>% 
  ggplot(.) + 
  geom_line(aes(y = V1, x = year, group = variable, color = skills), alpha = .2) + 
  geom_line(aes(y = V1, x = year, group = variable, color = skills, linetype = skills)) + 
  scale_linetype_manual(values=c("TRUE"="blank","FALSE"="solid")) + 
  ggtitle("Occupational Changers who were\npart time any time last year\nbecause they couldn't find a job") +
  geom_hline(yintercept = 0, linetype = "dotted")



skills_flows[, colMeans(.SD, na.rm = T), .SDcols = names(skills_flows)[names(skills_flows) %like% "skl|abl|knl|act|sty|inc" &
                                                                         names(skills_flows) %like% "diff"], by = .(year)] %>% .[,variable := rep(names(skills_flows)[names(skills_flows) %like% "skl|abl|knl|act|sty|inc" &
                                                                                                                                                                        names(skills_flows) %like% "diff"], 31)] %>% 
  data.table(.) %>% 
  .[, skills := (!variable %like% "log_inc")] %>% 
  ggplot(.) + 
  geom_line(aes(y = V1, x = year, group = variable, color = skills), alpha = .2) + 
  geom_line(aes(y = V1, x = year, group = variable, color = skills, linetype = skills)) + 
  scale_linetype_manual(values=c("TRUE"="blank","FALSE"="solid")) + 
  ggtitle("All Occupational Changers")+
  geom_hline(yintercept = 0, linetype = "dotted")

```

## Amongst Job Movers, are changes in income similar to changes in skills?

```{r}
skills_flows[, .SDcols = names(skills_flows)[names(skills_flows) %like% "skl|abl|knl|act|sty|inc" &
                                               names(skills_flows) %like% "diff"], by = .(year)] %>% 
  .[sample(nrow(skills_flows), 10000)] %>% 
  .[, .SD, .SDcols = names(skills_flows)[names(skills_flows) %like% "diff"]] %>% 
  melt(., id.vars = "occ_median_log_inc_diff") %>% 
  data.table(.) -> diffs

sloper <- function(c.var){
  mod <- lm(occ_median_log_inc_diff ~ value, data = diffs[variable == c.var])
  return(data.table(variable = c.var, slope = mod$coefficients[2], se = summary(mod)$coefficients[2,2], rsquared = summary(mod)$r.squared))
  
}

lapply(unique(diffs$variable), sloper) %>% rbindlist() -> out_dt

ggplot(out_dt[variable %like% "skl"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, Change in log_income ~ Change in skills") +
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "knl"]) + 
  geom_point(aes(y = variable, x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, Change in log_income ~ Change in knowledge")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "abl"]) + 
  geom_point(aes(y = substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, Change in log_income ~ Change in abilities")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "act"]) + 
  geom_point(aes(y =  substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, Change in log_income ~ Change in work activities")+
  geom_vline(xintercept = 0, linetype = 3)

ggplot(out_dt[variable %like% "sty"]) + 
  geom_point(aes(y =  substr(variable, 4,24), x = rsquared)) + 
  #geom_errorbarh(aes(y = variable, xmin = slope - (se*1.96), xmax = slope + (se*1.96)), height = 0) + 
  ggtitle("R-squared Coefficients, Change in log_income ~ Change in work styles")+
  geom_vline(xintercept = 0, linetype = 3)


```

# Evaluate amongst job movers who moved for location, if spouses face wage penalty

Subset to people who have moved with partners where one of them moved for a new job

```{r}
# moved <- acs[whymove != "niu"]
# moved <- moved[as.numeric(relate) %in% c(1,2,3,4,11,12,14,15)]
# moved <- moved[serial %in% moved[whymove %like% "new job|to look for|other job", serial]]
# moved[,n := .N, by = .(year, serial)]
# moved <- moved[n == 2]
# moved <- moved[serial %in% moved[OCC2010 != OCC10LY, unique(serial)]]
# moved[, straight := sort(unique(sex)) == c("male", "female"), by = .(year, serial)]
# moved <- moved[straight == T]
# 
# for(c.skill in vars){
#   #acs[, paste0(c.skill, "_distance") := abs(get(paste0(c.skill, '_current')) - get(paste0(c.skill, '_ly')))]
#   moved[, paste0(c.skill, "_diff") := (get(paste0(c.skill, '_current')) - get(paste0(c.skill, '_ly')))]
# }
# 
# #cast wide by household
# moved_wide <- melt(moved[,.SD,.SDcols = names(moved)[names(moved) %like% "diff|year|sex|serial"]], id.vars = c("year", "sex", "serial")) %>% dcast(. ,year + serial + variable ~ sex)
# 
# ##
# ggplot(moved_wide[variable %like% "average"]) + 
#   geom_density(aes(x = male)) + 
#   facet_wrap(~variable)
# ggplot(moved_wide[variable %like% "average"]) + 
#   geom_density(aes(x = female)) + 
#   facet_wrap(~variable)
# 
# moved_wide[,.(mean_male = mean(male, na.rm = T), mean_female = mean(female, na.rm = T)), by = .(variable)]

```
